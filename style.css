// state.js
import { CACHE_KEY } from './utils.js';

// --- Core State ---
export let cardDatabase = [];
export let keywordDatabase = {};
export let cardTitleCache = {};
export let searchIndex = new Map();

// --- Deck State ---
export let startingDeck = [];
export let purchaseDeck = [];
export let selectedWrestler = null;
export let selectedManager = null;

// --- UI State ---
export let currentSort = 'alpha-asc';
export let currentViewMode = 'list';
export let numGridColumns = 3;
export let showZeroCost = true;
export let showNonZeroCost = true;

// --- State Setters ---
export function setCardDatabase(data) {
    cardDatabase = data;
    cardTitleCache = Object.fromEntries(data.map(c => [c.title, c]));
    document.dispatchEvent(new CustomEvent('databaseLoaded'));
}

export function setKeywordDatabase(data) {
    keywordDatabase = data;
}

export function buildSearchIndex() {
    searchIndex.clear();
    cardDatabase.forEach(card => {
        const fullText = `${card.title} ${card.card_raw_game_text || ''}`.toLowerCase();
        const terms = fullText.split(/\s+/).filter(Boolean);
        terms.forEach(term => {
            if (!searchIndex.has(term)) {
                searchIndex.set(term, new Set());
            }
            searchIndex.get(term).add(card.title);
        });
    });
}

export function setStartingDeck(deck) {
    startingDeck = deck;
    saveStateToCache();
    document.dispatchEvent(new CustomEvent('deckChanged', { detail: { deckName: 'starting' } }));
}

export function setPurchaseDeck(deck) {
    purchaseDeck = deck;
    saveStateToCache();
    document.dispatchEvent(new CustomEvent('deckChanged', { detail: { deckName: 'purchase' } }));
}

export function setSelectedWrestler(wrestler) {
    selectedWrestler = wrestler;
    saveStateToCache();
    document.dispatchEvent(new CustomEvent('personaChanged'));
}

export function setSelectedManager(manager) {
    selectedManager = manager;
    saveStateToCache();
    document.dispatchEvent(new CustomEvent('personaChanged'));
}

export function setCurrentSort(sort) {
    currentSort = sort;
    document.dispatchEvent(new CustomEvent('filtersChanged'));
}

export function setViewMode(mode) {
    currentViewMode = mode;
}

export function setGridColumns(num) {
    numGridColumns = num;
}

export function setShowZeroCost(value) {
    showZeroCost = value;
    document.dispatchEvent(new CustomEvent('filtersChanged'));
}

export function setShowNonZeroCost(value) {
    showNonZeroCost = value;
    document.dispatchEvent(new CustomEvent('filtersChanged'));
}

// --- LocalStorage Persistence ---
export function saveStateToCache() {
    const stateToSave = {
        startingDeck,
        purchaseDeck,
        selectedWrestlerTitle: selectedWrestler ? selectedWrestler.title : null,
        selectedManagerTitle: selectedManager ? selectedManager.title : null,
    };
    localStorage.setItem(CACHE_KEY, JSON.stringify(stateToSave));
}

export function loadStateFromCache() {
    const cachedState = localStorage.getItem(CACHE_KEY);
    if (cachedState) {
        const parsed = JSON.parse(cachedState);
        startingDeck = parsed.startingDeck || [];
        purchaseDeck = parsed.purchaseDeck || [];
        if (parsed.selectedWrestlerTitle) {
            selectedWrestler = cardTitleCache[parsed.selectedWrestlerTitle] || null;
        }
        if (parsed.selectedManagerTitle) {
            selectedManager = cardTitleCache[parsed.selectedManagerTitle] || null;
        }
    }
}

